{% extends "base.html" %}

{% block title %}Agrix{% endblock %}

{% block content %}
   

<header>
  <h1>ðŸŒ± Crop Disease Detection</h1>
</header>

<div class="container">
  <div class="upload" onclick="document.getElementById('imageInput').click();">
    <p>Click or drag & drop an image of your crop</p>
    <input type="file" id="imageInput" accept="image/*" hidden>
  </div>
  <img id="preview" alt="Image preview">

  <div class="results" id="results">
    <h2>Analysis Results</h2>
    <p><strong>Plant:</strong> <span id="plantName"></span></p>
    <p><strong>Disease:</strong> <span id="diseaseName"></span></p>
    <p><strong>Confidence:</strong> <span id="confidence"></span>%</p>
    <p><strong>Description:</strong> <span id="description"></span></p>
    
    <div class="recommendations">
      <h3>Recommendations</h3>
      <ul id="recommendList"></ul>
    </div>

    <button class="btn" onclick="downloadPDF()">ðŸ“„ Download PDF Report</button>
  </div>
</div>

<script>
  // ===== CONFIG =====
const NABTA_API_KEY = "nabta_sk_1234567890abcdef1234567890abcdef";  
const NABTA_API_URL = "https://api.nabta.ma/analyze";  

// ===== DOM ELEMENTS =====
const imageInput = document.getElementById("imageInput");
const preview = document.getElementById("preview");
const resultsDiv = document.getElementById("results");
const plantName = document.getElementById("plantName");
const diseaseName = document.getElementById("diseaseName");
const confidence = document.getElementById("confidence");
const description = document.getElementById("description");
const recommendList = document.getElementById("recommendList");
const loadingOverlay = document.getElementById("loadingOverlay");

// ===== IMAGE UPLOAD + PREVIEW =====
imageInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(ev) {
        preview.src = ev.target.result;
        preview.style.display = "block";
        analyzeImage(file); // trigger API call
    };
    reader.readAsDataURL(file);
});

// ===== API CALL =====
async function analyzeImage(file) {
    try {
        showLoading();

        const formData = new FormData();
        formData.append("image", file);

        const response = await fetch(NABTA_API_URL, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${NABTA_API_KEY}`
            },
            body: formData
        });

        if (!response.ok) throw new Error("Network error while analyzing");

        const apiResponse = await response.json();
        console.log("API Response:", apiResponse);

        if (apiResponse.status !== "success") {
            showError(apiResponse.message || "Analysis failed");
            return;
        }

        processResults(apiResponse.analysis);

    } catch (error) {
        console.error("Error:", error);
        showError("Failed to analyze image. Please try again.");
    } finally {
        hideLoading();
    }
}

// ===== DISPLAY RESULTS =====
function processResults(analysis) {
    resultsDiv.style.display = "block";
    plantName.textContent = analysis.plant || "Unknown";
    diseaseName.textContent = analysis.disease || "Unknown";
    confidence.textContent = analysis.confidence || "--";
    description.textContent = analysis.description || "No description available";
    recommendList.innerHTML = (analysis.recommendations || [])
        .map(r => `<li>${r}</li>`)
        .join("");
}

// ===== LOADING OVERLAY =====
function showLoading() {
    loadingOverlay.style.display = "flex";
}
function hideLoading() {
    loadingOverlay.style.display = "none";
}

// ===== ERROR HANDLER =====
function showError(message) {
    resultsDiv.style.display = "block";
    plantName.textContent = "Error";
    diseaseName.textContent = message;
    confidence.textContent = "--";
    description.textContent = "";
    recommendList.innerHTML = "";
}

// ===== PDF DOWNLOAD (Optional) =====
function downloadPDF() {
    if (resultsDiv.style.display === "none") return;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(18);
    doc.text("ðŸŒ± Crop Health Analysis Report", 20, 20);

    doc.setFontSize(12);
    doc.text(`Plant: ${plantName.textContent}`, 20, 40);
    doc.text(`Disease: ${diseaseName.textContent}`, 20, 50);
    doc.text(`Confidence: ${confidence.textContent}%`, 20, 60);
    doc.text(`Description: ${description.textContent}`, 20, 70);

    doc.text("Recommendations:", 20, 90);
    [...recommendList.children].forEach((li, i) => {
        doc.text(`- ${li.textContent}`, 25, 100 + i * 10);
    });

    doc.save("crop_report.pdf");
}
</script>
{%endblock%}
